<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wallet - Menú Principal</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    .container { max-width: 480px; margin: 0 auto; }
    .saldo { font-size: 1.5rem; font-weight: 600; }
    .small-info { font-size: 0.9rem; color:#666; }
    .user-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .user-name { font-weight:600; color:#333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Menú Principal</h2>

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="small-info">Saldo disponible</div>
            <div id="saldoDisplay" class="saldo">$0</div>
          </div>
          <div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-primary">Actualizar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="mb-3 user-row">
      <div>
        <div class="small-info">Sesión</div>
        <div id="userDisplay" class="user-name">Invitado</div>
      </div>
      <div>
        <button id="logoutBtn" class="btn btn-outline-secondary">Cerrar Sesión</button>
      </div>
    </div>

    <div class="list-group mb-3">
      <a href="deposit.html" class="list-group-item list-group-item-action">Depositar</a>
      <a href="retirar.html" class="list-group-item list-group-item-action">Retirar</a>
      <a href="sendmoney.html" class="list-group-item list-group-item-action">Enviar Dinero</a>
      <a href="transactions.html" class="list-group-item list-group-item-action">Últimos Movimientos</a>
    </div>

    <div class="mb-3">
      <button id="resetBtn" class="btn btn-danger">Resetear datos (saldo, contactos, transacciones)</button>
      <button id="seedBtn" class="btn btn-secondary ml-2">Cargar datos de prueba</button>
    </div>

    <div class="small-info">
      Uso: empieza con saldo 0; haz un depósito antes de retirar o enviar. Los movimientos se registran en el historial.
    </div>
  </div>

  <script>
    //  valores por defecto si no existen
    function initStorage() {
      if (localStorage.getItem('saldo') === null) localStorage.setItem('saldo', '0');
      if (localStorage.getItem('contacts') === null) {
        const defaults = [
          { name: "Camila Rojas", cbu: "00123456789", alias: "camila.rojas", bank: "BancoEstado" },
          { name: "Felipe González", cbu: "00987654321", alias: "felipe.gonzalez", bank: "Banco de Chile" },
          { name: "María Torres", cbu: "00543219876", alias: "maria.torres", bank: "BCI" }
        ];
        localStorage.setItem('contacts', JSON.stringify(defaults));
      }
      if (localStorage.getItem('transactions') === null) localStorage.setItem('transactions', JSON.stringify([]));
      if (localStorage.getItem('users') === null) localStorage.setItem('users', JSON.stringify([]));
    }

    function formatMoney(n) {
      const v = Number(n);
      if (isNaN(v)) return '$0';
      return '$' + v.toLocaleString();
    }

    function showSaldo() {
      const saldo = parseFloat(localStorage.getItem('saldo') || '0');
      document.getElementById('saldoDisplay').textContent = formatMoney(isNaN(saldo) ? 0 : saldo);
    }

    function showUser() {
      const cu = localStorage.getItem('currentUser');
      if (cu) {
        try {
          const user = JSON.parse(cu);
          document.getElementById('userDisplay').textContent = user.name || user.email || 'Usuario';
          document.getElementById('logoutBtn').textContent = 'Cerrar Sesión';
        } catch {
          document.getElementById('userDisplay').textContent = 'Usuario';
        }
      } else {
        document.getElementById('userDisplay').textContent = 'Invitado';
        document.getElementById('logoutBtn').textContent = 'Entrar / Registrar';
      }
    }

    // Logout: si hay currentUser lo elimina y redirige a index; si no hay, va a login
    document.getElementById('logoutBtn').addEventListener('click', function() {
      const cu = localStorage.getItem('currentUser');
      if (cu) {
        if (!confirm('¿Cerrar sesión?')) return;
        localStorage.removeItem('currentUser');
        // redirigir al index (pantalla de inicio)
        window.location.href = 'index.html';
      } else {
        window.location.href = 'login.html';
      }
    });

    // Resetear storage para pruebas
    document.getElementById('resetBtn').addEventListener('click', function() {
      if (!confirm('¿Seguro que quieres resetear saldo, contactos y transacciones?')) return;
      localStorage.setItem('saldo', '0');
      localStorage.setItem('contacts', JSON.stringify([]));
      localStorage.setItem('transactions', JSON.stringify([]));
      showSaldo();
      alert('Datos reseteados.');
    });

    // Cargar datos de prueba 
    document.getElementById('seedBtn').addEventListener('click', function() {
      localStorage.setItem('saldo', '10000');
      const contacts = [
        { name: "Camila Rojas", cbu: "00123456789", alias: "camila.rojas", bank: "BancoEstado" },
        { name: "Felipe González", cbu: "00987654321", alias: "felipe.gonzalez", bank: "Banco de Chile" },
        { name: "María Torres", cbu: "00543219876", alias: "maria.torres", bank: "BCI" }
      ];
      localStorage.setItem('contacts', JSON.stringify(contacts));
      const txs = [
        { date: new Date().toISOString(), type: 'deposito', amount: 10000, detail: 'Depósito inicial de prueba' }
      ];
      localStorage.setItem('transactions', JSON.stringify(txs));
      showSaldo();
      alert('Datos de prueba cargados (saldo $10.000).');
    });

    // Botón actualizar
    document.getElementById('refreshBtn').addEventListener('click', showSaldo);

    // Inicialización al cargar la página
    initStorage();
    showSaldo();
    showUser();
  </script>
</body>
</html>
